name: CI/CD Pipeline

on:
  push:
    branches:
      - main  # Trigger on push to 'mani' branch

jobs:
  # Step 1: Checkout code
  checkout:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

  # Step 2: SonarQube scan
  sonarqube:
    runs-on: ubuntu-latest
    needs: checkout  # Depends on the 'checkout' job
    steps:
      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@v1
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

  # Step 3: Build the application
  build:
    runs-on: ubuntu-latest
    needs: checkout  # Can run after checkout, independent of SonarQube
    steps:
      - name: Set up Go environment
        uses: actions/setup-go@v5
        with:
          go-version: '1.23.2'

      - name: Build the application
        run: go build -o app-binary main.go

  # Step 4: Build Docker image
  docker_build:
    runs-on: ubuntu-latest
    needs: build  # Run after the build job completes
    steps:
      - name: Docker Build
        run: |
          docker build -t my-app:latest .

  # Step 5: Trivy vulnerability scan
  trivy_scan:
    runs-on: ubuntu-latest
    needs: docker_build  # Run after Docker build completes
    steps:
      - name: Trivy Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'my-app:latest'
